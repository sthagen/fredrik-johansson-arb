/*
    Copyright (C) 2013-2014 Fredrik Johansson
    Copyright (C) 2022 Fredrik Johansson

    This file is part of Arb.

    Arb is free software: you can redistribute it and/or modify it under
    the terms of the GNU Lesser General Public License (LGPL) as published
    by the Free Software Foundation; either version 2.1 of the License, or
    (at your option) any later version.  See <http://www.gnu.org/licenses/>.
*/

#include "flint/thread_support.h"
#include "arb.h"

#define HAVE_64_BIT (FLINT_BITS == 64)

/* one coefficient doesn't fit in 64 bits */
#define L24_FIXME 0
#define L24_FIXME_STR "19182937474703818751"

static const ulong log_atanh_4_x[] = {251, 449, 4801, 8749};
static const ulong log_atanh_4_den = 1;
static const slong log_atanh_4_c[] = {
    144, 54, -38, 62,
    228, 86, -60, 98,
    334, 126, -88, 144,
    404, 152, -106, 174,
};

static const ulong log_atanh_8_x[] = {57799, 74359, 87361, 388961, 672281, 1419263, 11819521, 23718421};
static const ulong log_atanh_8_den = 1;
static const slong log_atanh_8_c[] = {
    17078, 16538, 6790, 24056, 20056, 8490, -2564, 2356,
    27068, 26212, 10762, 38128, 31788, 13456, -4064, 3734,
    39654, 38400, 15766, 55856, 46568, 19712, -5954, 5470,
    47944, 46428, 19062, 67534, 56304, 23834, -7198, 6614,
    59080, 57212, 23490, 83220, 69382, 29370, -8870, 8150,
    63196, 61198, 25126, 89018, 74216, 31416, -9488, 8718,
    69806, 67598, 27754, 98328, 81978, 34702, -10480, 9630,
    72546, 70252, 28844, 102188, 85196, 36064, -10892, 10008,
};

#if HAVE_64_BIT
static const ulong log_atanh_12_x[] = {36171409, 42772001, 55989361, 100962049, 143687501, 287080366, 362074049, 617831551, 740512499, 3222617399, 6926399999, 9447152318};
static const ulong log_atanh_12_den = 1;
static const slong log_atanh_12_c[] = {
    17325186, 3191278, 1683636, -1195752, 3410458, 18802224, 7208106, 6805862, -482400, -837914, 7774420, 9161220,
    27459770, 5058056, 2668500, -1895222, 5405448, 29800820, 11424578, 10787036, -764586, -1328062, 12322164, 14520190,
    40227836, 7409918, 3909282, -2776450, 7918838, 43657412, 16736704, 15802722, -1120098, -1945576, 18051644, 21271694,
    48637946, 8959050, 4726564, -3356900, 9574366, 52784516, 20235712, 19106470, -1354268, -2352322, 21825556, 25718796,
    59935296, 11040008, 5824424, -4136622, 11798246, 65045008, 24935950, 23544414, -1668830, -2898706, 26895074, 31692614,
    64110806, 11809132, 6230194, -4424808, 12620194, 69576496, 26673162, 25184682, -1785092, -3100650, 28768772, 33900542,
    70816054, 13044230, 6881800, -4887592, 13940120, 76853392, 29462866, 27818708, -1971792, -3424942, 31777652, 37446146,
    73596134, 13556318, 7151964, -5079468, 14487378, 79870484, 30619512, 28910808, -2049200, -3559398, 33025172, 38916198,
    78371552, 14435944, 7616032, -5409058, 15427418, 85053024, 32606314, 30786738, -2182166, -3790356, 35168070, 41441346,
    84165424, 15503168, 8179072, -5808940, 16567940, 91340846, 35016842, 33062748, -2343490, -4070570, 37767984, 44505032,
    85832372, 15810218, 8341064, -5923990, 16896078, 93149908, 35710372, 33717576, -2389904, -4151190, 38516002, 45386482,
    90254748, 16624814, 8770824, -6229214, 17766622, 97949308, 37550292, 35454820, -2513040, -4365074, 40500478, 47724948,
};
#endif

#if HAVE_64_BIT
static const ulong log_atanh_13_x[] = {51744295, 170918749, 265326335, 287080366, 362074049, 587270881, 831409151, 2470954914, 3222617399, 6926399999, 9447152318, 90211378321, 127855050751};
static const slong log_atanh_13_den = 1;
static const slong log_atanh_13_c[] = {
    3191278, 35138256, 17325186, 62225852, 26216928, 22419280, 9733920, 31220668, 40902078, -34447972, 9161220, 6323462, 19491222,
    5058056, 55692818, 27459770, 98625642, 41552848, 35533718, 15427898, 49483588, 64828260, -54598744, 14520190, 10022450, 30892856,
    7409918, 81588504, 40227836, 144483954, 60873822, 52055956, 22601462, 72492146, 94971684, -79985714, 21271694, 14682624, 45257216,
    8959050, 98645556, 48637946, 174690052, 73600222, 62938876, 27326568, 87647496, 114826650, -96707684, 25718796, 17752202, 54718778,
    11040008, 121558394, 59935296, 215266080, 90695670, 77557966, 33673830, 108005766, 141497942, -119170404, 31692614, 21875584, 67428550,
    11809132, 130026998, 64110806, 230263014, 97014162, 82961194, 36019784, 115530200, 151355674, -127472644, 33900542, 23399590, 72126092,
    13044230, 143626316, 70816054, 254345858, 107160720, 91637974, 39787036, 127613320, 167185724, -140804806, 37446146, 25846916, 79669646,
    13556318, 149264764, 73596134, 264330908, 111367610, 95235476, 41348986, 132623134, 173749062, -146332488, 38916198, 26861608, 82797298,
    14435944, 158950078, 78371552, 281482496, 118593898, 101415002, 44031990, 141228626, 185023084, -155827536, 41441346, 28604572, 88169750,
    15503168, 170700980, 84165424, 302292006, 127361338, 108912436, 47287198, 151669412, 198701518, -167347594, 44505032, 30719258, 94687986,
    15810218, 174081818, 85832372, 308279086, 129883808, 111069514, 48223750, 154673318, 202636924, -170662016, 45386482, 31327672, 96563340,
    16624814, 183051106, 90254748, 324162674, 136575864, 116792194, 50708402, 162642614, 213077468, -179455104, 47724948, 32941780, 101538612,
    17097438, 188255034, 92820584, 333378238, 140458556, 120112458, 52149982, 167266352, 219135010, -184556802, 49081712, 33878276, 104425236,
};
#else
/* Arndt formula with 32-bit x */
static const ulong log_atanh_13_x[] = { 51744295, 170918749, 265326335, 287080366, 362074049, 587270881, 617831551, 740512499, 831409151, 1752438401, 2151548801, 2470954914, 3222617399 };
static const slong log_atanh_13_den = 1;
static const slong log_atanh_13_c[] = {
    3191278, 35138256, 17325186, 62225852, 26216928, 22419280, 25814684, -19491222, 3410458, 24117970, -9161220, -9550766, 25945328,
    5058056, 55692818, 27459770, 98625642, 41552848, 35533718, 40915306, -30892856, 5405448, 38226078, -14520190, -15137606, 41122372,
    7409918, 81588504, 40227836, 144483954, 60873822, 52055956, 59939840, -45257216, 7918838, 56000192, -21271694, -22176192, 60243186,
    8959050, 98645556, 48637946, 174690052, 73600222, 62938876, 72470980, -54718778, 9574366, 67707702, -25718796, -26812390, 72837744,
    11040008, 121558394, 59935296, 215266080, 90695670, 77557966, 89304134, -67428550, 11798246, 83434468, -31692614, -33040222, 89756088,
    11809132, 130026998, 64110806, 230263014, 97014162, 82961194, 95525682, -72126092, 12620194, 89247094, -33900542, -35342034, 96009122,
    13044230, 143626316, 70816054, 254345858, 107160720, 91637974, 105516562, -79669646, 13940120, 98581306, -37446146, -39038402, 106050564,
    13556318, 149264764, 73596134, 264330908, 111367610, 95235476, 109658906, -82797298, 14487378, 102451388, -38916198, -40570962, 110213872,
    14435944, 158950078, 78371552, 281482496, 118593898, 101415002, 116774322, -88169750, 15427418, 109099132, -41441346, -43203482, 117365298,
    15503168, 170700980, 84165424, 302292006, 127361338, 108912436, 125407244, -94687986, 16567940, 117164640, -44505032, -46397440, 126041910,
    15810218, 174081818, 85832372, 308279086, 129883808, 111069514, 127891012, -96563340, 16896078, 119485158, -45386482, -47316370, 128538248,
    16624814, 183051106, 90254748, 324162674, 136575864, 116792194, 134480392, -101538612, 17766622, 125641440, -47724948, -49754270, 135160976,
    17097438, 188255034, 92820584, 333378238, 140458556, 120112458, 138303512, -104425236, 18271706, 129213278, -49081712, -51168726, 139003444,
};
#endif

#if HAVE_64_BIT
static const ulong log_atanh_16_x[] = {9943658495, 15913962107, 19030755899, 22429958849, 22623739319, 36974504449, 90211378321, 123679505951, 127855050751, 187753824257, 384918250001, 569165414399, 842277599279, 1068652740673, 2218993446251, 2907159732049};
static const ulong log_atanh_16_den = 1;
static const slong log_atanh_16_c[] = {
    2795845166, 4115492742, 653556516, 2293232066, 974581744, -2713448948, 894308352, 387970172, 2837123522, 1960851594, -546800620, -845945652, -60363442, 2786163756, 477501928, 4560908494,
    4431309746, 6522901668, 1035862570, 3634686830, 1544675518, -4300714830, 1417445202, 614918174, 4496734392, 3107876246, -866658478, -1340792136, -95673792, 4415965074, 756822650, 7228868932,
    6491751440, 9555878222, 1517511236, 5324719962, 2262908732, -6300433346, 2076519688, 900838842, 6587596814, 4552956406, -1269631722, -1964224976, -140159572, 6469271902, 1108725142, 10590101570,
    7848929688, 11553648806, 1834765102, 6437916328, 2735996856, -7617614260, 2510640954, 1089169972, 7964812684, 5504806374, -1535063412, -2374869690, -169461606, 7821750534, 1340517388, 12804088910,
    9672035168, 14237265718, 2260934076, 7933279518, 3371498900, -9386991086, 3093798590, 1342156280, 9814834818, 6783432004, -1891619354, -2926491136, -208823200, 9638542992, 1651885268, 15778151054,
    10345856498, 15229132802, 2418446490, 8485967020, 3606380994, -10040954260, 3309334146, 1435660234, 10498604566, 7256013120, -2023402732, -3130370890, -223371278, 10310031024, 1766967100, 16877366942,
    11427913226, 16821923656, 2671387974, 9373500856, 3983566664, -11091121746, 3655452158, 1585813662, 11596636972, 8014908028, -2235027216, -3457771418, -246733326, 11388340822, 1951771388, 18642543992,
    11876547604, 17482314850, 2776260706, 9741483588, 4139952604, -11526534442, 3798957054, 1648069168, 12051895068, 8329555436, -2322769398, -3593515810, -256419526, 11835421676, 2028393578, 19374408678,
    12647178828, 18616686398, 2956403392, 10373577330, 4408580900, -12274454430, 4045459238, 1755007110, 12833904028, 8870033672, -2473486482, -3826687568, -273057770, 12603384370, 2160009556, 20631552148,
    13582162682, 19992985526, 3174965134, 11140477794, 4734499590, -13181883420, 4344532978, 1884751722, 13782692150, 9525779778, -2656347020, -4109587900, -293244454, 13535130576, 2319695292, 22156806784,
    13851165806, 20388958958, 3237847280, 11361121840, 4828269280, -13442958766, 4430579138, 1922080394, 14055666884, 9714443732, -2708957614, -4190980828, -299052342, 13803202200, 2365638290, 22595636032,
    14564825010, 21439467516, 3404672192, 11946485504, 5077038146, -14135585754, 4658857654, 2021112518, 14779862680, 10214964936, -2848532330, -4406914424, -314460536, 14514390156, 2487524026, 23759840104,
    14978885874, 22048966390, 3501463022, 12286110052, 5221372376, -14537443850, 4791303504, 2078570372, 15200036812, 10505364388, -2929512758, -4532197824, -323400280, 14927017216, 2558241412, 24435304444,
    15170996084, 22331753214, 3546370688, 12443684334, 5288338568, -14723892390, 4852753890, 2105228870, 15394983372, 10640099894, -2967084932, -4590325076, -327548018, 15118462190, 2591051882, 24748697010,
    15529770390, 22859870104, 3630237738, 12737961268, 5413400890, -15072093276, 4967515202, 2155014792, 15759054686, 10891724404, -3037252628, -4698880288, -335294102, 15475994138, 2652326886, 25333971474,
    16014378714, 23573215058, 3743519736, 13135450858, 5582326706, -15542419732, 5122527102, 2222262284, 16250817854, 11231601954, -3132030456, -4845509404, -345756994, 15958924368, 2735093060, 26124521054,
};

static const ulong log_atanh_20_x[] = {932784765626, 1986251708497, 2200009162625, 2218993446251, 2907159732049, 5175027061249, 7233275252995, 8152552404881, 8949772845287, 9164582675249, 12066279000049, 13055714577751, 22518692773919, 25640240468751, 31041668486401, 41257182408961, 63774701665793, 115445619421397, 121336489966251, 238178082107393};
static const ulong log_atanh_20_den = 1;
static const slong log_atanh_20_c[] = {
    -116089335710, -440487517368, 804976818014, -442021938612, 2027028904414, -2259886314980, 1755029607116, 2232338696382, 231770587740, 419733644928, -445576594600, 820684665848, 282573414662, -955021371140, 582451140742, 1373640195020, -1386573872206, -391661105906, -546462355792, 72583300802,
    -183997243834, -698156197064, 1275858070502, -700588197196, 3212764801374, -3581835065136, 2781656114934, 3538173122674, 367347690338, 665262087502, -706222193640, 1300754420286, 447868265940, -1513673060644, 923163216578, 2177168198590, -2197667591926, -620768165852, -866122341986, 115041809950,
    -269551090102, -1022780342024, 1869098289480, -1026343157820, 4706615362308, -5247293526004, 4075052552122, 5183329936434, 538154639242, 974591342528, -1034596813426, 1905570782676, 656115150372, -2217490952868, 1352409667588, 3189493761084, -3219524829512, -909408925478, -1268846296712, 168533205352,
    -325903968004, -1236604799988, 2259855632194, -1240912465020, 5690589571960, -6344302969650, 4926991005894, 6266967026988, 650662300280, 1178341314042, -1250891646004, 2303953136126, 793283866494, -2681083946940, 1635147076820, 3856295562626, -3892604984934, -1099531733444, -1534113784252, 203767086766,
    -401603118542, -1523836445198, 2784762256508, -1529144670566, 7012367883822, -7817922172568, 6071404914502, 7722623069772, 801794499498, 1452039842670, -1541441759884, 2839102481966, 977543405268, -3303831127796, 2014949892594, 4752014323284, -4796757495086, -1354924813562, -1890449152022, 251096965780,
    -429581588714, -1629997504614, 2978768189562, -1635675537930, 7500898267714, -8362573078436, 6494381264686, 8260634776436, 857653088370, 1553199050732, -1648829328132, 3036894133574, 1045645886906, -3533999013440, 2155325335078, 5083072736088, -5130933028848, -1449318312346, -2022151005842, 268590129162,
    -474510845980, -1800476359276, 3290312831700, -1806748249094, 8285405324932, -9237201337930, 7173618304380, 9124601470546, 947353665082, 1715645676866, -1821277773358, 3354518076038, 1155008332356, -3903614367134, 2380747394626, 5614703254392, -5667569179290, -1600900216754, -2233644573442, 296681544924,
    -493139083180, -1871159044356, 3419483172926, -1877677154576, 8610671853606, -9599833254658, 7455238554976, 9482812967686, 984544656468, 1782998098608, -1892777075548, 3486208971918, 1200351382710, -4056861558392, 2474210225994, 5835123977998, -5890065301166, -1663747987724, -2321332476230, 308328600494,
    -525137302522, -1992572575684, 3641362509476, -1999513625248, 9169390835836, -10222735759458, 7938985162504, 10098122399988, 1048428613234, 1898691147874, -2015593331842, 3712417932350, 1278238348358, -4320098341710, 2634753821522, 6213746527504, -6272252817574, -1771703278344, -2471956323078, 328335058154,
    -563959786616, -2139879987964, 3910562083430, -2147334177206, 9847267894216, -10978484769320, 8525900477254, 10844658961710, 1125937110470, 2039058070076, -2164602628440, 3986870509682, 1372736278156, -4639475670938, 2829536572314, 6673117961550, -6735949519516, -1902682209022, -2654703738990, 352608295860,
    -575129358650, -2182261633316, 3988013181752, -2189863457382, 10042299119296, -11195920443568, 8694761204194, 11059444133150, 1148236990638, 2079442875048, -2207473920962, 4065832943536, 1399924168332, -4731363353242, 2885577292444, 6805283185968, -6869359161762, -1940366005802, -2707281786830, 359591921030,
    -604761980628, -2294699179870, 4193489193856, -2302692675784, 10559712548326, -11772772369510, 9142744893568, 11629264335090, 1207398068356, 2186582849238, -2321210490384, 4275318494622, 1472053026048, -4975139296132, 3034252055452, 7155914537110, -7223291925256, -2040340266348, -2846770158570, 378119320652,
    -621954653248, -2359934781684, 4312705165022, -2368155523296, 10859912770262, -12107458457030, 9402662389768, 11959870657788, 1241722976958, 2248744830790, -2387199777610, 4396860776674, 1513901764174, -5116576661404, 3120512276674, 7359348780454, -7428641628588, -2098344743078, -2927700489722, 388868808714,
    -629931470760, -2390201890380, 4368017335942, -2398528066296, 10999195500784, -12262741460610, 9523255300552, 12113260788736, 1257648571430, 2277585883836, -2417816570798, 4453252277016, 1533318160596, -5182198806204, 3160534096344, 7453735375880, -7523916932542, -2125256854766, -2965249421006, 393856206922,
    -644828529934, -2446727053276, 4471315259200, -2455250132412, 11259312154488, -12552739331248, 9748467890052, 12399723636094, 1287390322808, 2331447824792, -2474994784934, 4558565895664, 1569579138862, -5304751061248, 3235276613012, 7630006513476, -7701847772584, -2175516412502, -3035373709344, 403170393454,
    -664950480570, -2523077460712, 4610843181352, -2531866503542, 11610660323584, -12944449048562, 10052669984964, 12786658480520, 1327563490282, 2404200930252, -2552227290284, 4700816484258, 1618558041758, -5470286446298, 3336233802840, 7868101770266, -7942184844372, -2243403659776, -3130092905390, 415751373324,
    -682912123820, -2591230832376, 4735391283388, -2600257284842, 11924287495408, -13294104523166, 10324212719726, 13132051716094, 1363423637016, 2469143208920, -2621168057182, 4827794945270, 1662278533696, -5618049830928, 3426352154678, 8080634945560, -8156719151760, -2304002482364, -3214642979038, 426981649964,
    -688495357788, -2612415765984, 4774106070468, -2621516015348, 12021776007726, -13402792146898, 10408619619450, 13239414456718, 1374570478458, 2489329999806, -2642597746338, 4867265190110, 1675868700938, -5663980903990, 3454364727704, 8146699192982, -8223405435180, -2322839144468, -3240924697068, 430472492150,
    -704208264478, -2672036567638, 4883061174324, -2681344503760, 12296138125812, -13708671946964, 10646166128660, 13541565635564, 1405941056956, 2546141726370, -2702907364024, 4978346380276, 1714115536192, -5793244816128, 3533200568824, 8332623938590, -8411080777960, -2375851200860, -3314889389462, 440296776404,
    -713920057888, -2708886841112, 4950403867850, -2718323143738, 12465715166074, -13897729355958, 10792988271008, 13728318467836, 1425330504340, 2581255773856, -2740183379160, 5047003159822, 1737755042866, -5873139926234, 3581927225030, 8447539832562, -8527078676580, -2408616757868, -3360605298450, 446368945032,
};

static const ulong log_atanh_24_x[] = {134543112911873, 148569359956291, 166019820559361, 201842423186689, 206315395261249, 211089142289024, 217172824950401, 238178082107393, 259476225058051, 330190746672799, 386624124661501, 473599589105798, 478877529936961, 1796745215731101, 1814660314218751, 2767427997467797, 2838712971108351, 4573663454608289, 9747977591754401, 11305332448031249, 17431549081705001, 34903240221563713, 332110803172167361, L24_FIXME};
static const ulong log_atanh_24_den = 2;
static const slong log_atanh_24_c[] = {
    95300949339891, 8383110436820, -33446555503183, -57342856225640, 52380491656263, 102208933748031, 6896245322375, 38607613905573, -85720402524046, 25043219434553, 131214305964926, 114563664023695, -76722528792182, -31877386468039, -22332023559694, 3666995585797, 90133674519724, 45155648723502, -3541965146654, -61019828808695, 35149960568702, -16630104641178, -24161266171881, -23606318798422,
    151048430986854, 13286915681764, -53011536250834, -90886276801884, 83021115044514, 161997327229322, 10930290231738, 61191620282654, -135863623547336, 39692563701098, 207969754512560, 181579111422774, -121602331096108, -50524462172838, -35395419907336, 5812050493798, 142858494165968, 71570009922488, -5613881936308, -96714140462206, 55711369403220, -26358092239336, -38294700852374, -37415130075568,
    221281951741730, 19464979645796, -77660496900050, -133145988911400, 121623735200690, 237321794818034, 16012585763258, 89644103403914, -199036610925636, 58148554791518, 304670183471108, 266008590149854, -178144195113372, -74016999231722, -51853352918940, 8514500074490, 209283911162780, 104848169413964, -8224188385128, -141683654856126, 81615680978652, -38613907187268, -56100722732542, -54812174834924,
    267543589206106, 23534366346960, -93896352217734, -160981749669892, 147050631071006, 286936753235794, 19360208249486, 108385274926710, -240647593946640, 70305205343762, 368365127695008, 321620866085874, -215387368837440, -89491137803382, -62693916259812, 10294558106950, 253037214806084, 126767932702628, -9943553288216, -171304316749202, 98678414812676, -46686606118744, -67829249510774, -66271315270412,
    329687117432571, 29000797307664, -115706071642219, -198373689929952, 181206729035443, 353584817115143, 23857089118103, 133560400265081, -296543870854002, 86635305144365, 453926918872614, 396325161670511, -265416341965486, -110277638667055, -77256108410558, 12685720474909, 311811283537496, 156212878954162, -12253186220446, -211093925144635, 121598884985222, -57530709816938, -83584248141317, -81664445650894,
    352655418113885, 31021194821972, -123766962418989, -212193782729012, 193830851780593, 378217997990065, 25519140096961, 142865147918839, -317203182155022, 92670923865743, 485550629380930, 423935932609053, -283907092818814, -117960346996865, -82638306966754, 13569496111931, 333534229134788, 167095756034874, -13106828508950, -225800198117865, 130070310179518, -61538699731058, -89407308983007, -87353759680782,
    389539089162686, 34265652404600, -136711552787078, -234386794033464, 214103313251398, 417775218738894, 28188146499354, 157807187228370, -350378960054060, 102363228864014, 536333599872088, 468274719654342, -313600485524804, -130297632664286, -91281316470176, 14988708195974, 368418045344724, 184572036229868, -14477650921952, -249416282834998, 143674157695984, -67974934766920, -98758277675122, -96489950907260,
    404831524758217, 35610845472804, -142078543351889, -243588296660336, 222508531674341, 434176141787993, 29294750244373, 164002345337891, -364134056345354, 106381780861243, 557388860465814, 486658140447161, -325911740957278, -135412827034257, -94864817310094, 15577131440583, 382881315880104, 191817922599958, -15046011198130, -259207809662073, 149314484596246, -70643479056706, -102635307331167, -100277931114938,
    431099748810048, 37921519445424, -151297566035348, -259393962873952, 236946399295832, 462348444271744, 31195592979932, 174643933477388, -387761551715668, 113284554691332, 593556042553364, 518235832124084, -347059112416804, -144199332685348, -101020292176400, 16587881724940, 407725261017048, 204264374666708, -16022298787084, -276026976164124, 159003024385484, -75227308680080, -109294984465288, -106784645639096,
    462970200710807, 40724991182128, -162482730986943, -278570505750492, 254463432981563, 496529057680187, 33501828713835, 187555054620497, -416428086356502, 121659484069869, 637436604666466, 556548102559291, -372716586770550, -154859737636071, -108488546035734, 17814194865017, 437867677837832, 219365283321430, -17206799367850, -296433168678579, 170757840422238, -80788732293826, -117374971881217, -114679048087658,
    472139611596056, 41531574795660, -165700801869020, -284087766740112, 259503238499708, 506363122463072, 34165353131632, 191269698363832, -424675701909508, 124069025322872, 650061430481412, 567570881610592, -380098469065780, -157926830424736, -110637228722908, 18167016001360, 446539917747228, 223709948299100, -17547590661072, -302304210744476, 174139804959708, -82388803054672, -119699655723008, -116950337492960,
    496465851286329, 43671422879532, -174238271134753, -298724935359436, 272873728552017, 532452673911025, 35925668404849, 201124564199291, -446556439431958, 130461483769519, 683554807827650, 596814065127021, -399682435835998, -166063758223381, -116337635294350, 19103042496175, 469547174083276, 235236246219806, -18451702254178, -317879952557557, 183112080386350, -86633754593746, -125866989376963, -122976016914550,
    510579792177940, 44912950125720, -179191660483648, -307217334322204, 280631208075892, 547589677891640, 36946992951228, 206842299273324, -459251514379372, 134170350483680, 702987467956960, 613780787846540, -411044937929924, -170784755773828, -119644977589416, 19646119551612, 482895848606740, 241923736338428, -18976262471744, -326916906155476, 188317741707096, -89096650457352, -129445240013272, -126472080600140,
    517128182492702, 45488976698092, -181489865293110, -311157519671140, 284230415708346, 554612734812622, 37420852932582, 209495134598958, -465141598975108, 135891138961986, 712003563770176, 621652772261310, -416316753876636, -172975138663538, -121179472343144, 19898088902858, 489089181258168, 245026505144048, -19219640637672, -331109746402578, 190732992163116, -90239350681432, -131105427057454, -128094135684140,
    529357590757654, 46564731774744, -185781864324998, -318515989914292, 290952094999270, 567728603938670, 38305807386098, 214449421789770, -476141592221384, 139104787481286, 728841521093396, 636354050993358, -426162103101572, -177065775495990, -124045209100076, 20368652800018, 500655503647996, 250821062989836, -19674160116636, -338940060832054, 195243579111820, -92373393842120, -134205899720746, -131123395226864,
    545876257063253, 48017789743924, -191579209401365, -328455319097920, 300031289577985, 585444642254441, 39501144641717, 221141341391611, -490999646990874, 143445568847291, 751585107067814, 656211554511029, -439460541994554, -182591133988297, -127916054539358, 21004259022679, 516278517926468, 258647963962418, -20288094612870, -349516725567269, 201336178118558, -95255916535730, -138393810714063, -135215116302422,
    560621467231895, 49314846343192, -196754147255895, -337327554606316, 308135735163871, 601258673695539, 40568149612363, 227114811594065, -504262530096578, 147320320740317, 771886924961410, 673937141878415, -451331250728794, -187523285938031, -131371323171618, 21571626094829, 530224233926896, 265634563102734, -20836116651046, -358957871814719, 206774671224818, -97828969477586, -142132104509797, -138867547200558,
    565204898555282, 49718026072564, -198362735535598, -340085418459904, 310654937625698, 606174339611938, 40899819622402, 228971617303994, -508385191840280, 148524756553286, 778197583608588, 679446999753338, -455021166140040, -189056406149922, -132445365948808, 21747987637362, 534559148845864, 267806291886348, -21006464943608, -361892577047422, 208465183558664, -98628782523012, -143294123408370, -140002876300216,
    578104058631076, 50852695603208, -202889788795904, -347846880300328, 317744734226920, 620008508177144, 41833239204804, 234197229381964, -519987607152804, 151914402706204, 795957683047256, 694953403953372, -465405702570840, -193371069473816, -135468046716508, 22244322284460, 546758908700336, 273918192609744, -21485876489096, -370151723940008, 213222795850820, -100879698000032, -146564395553020, -143198035289608,
    586076738689057, 51554009261324, -205687858363053, -352644064897800, 322126777681341, 628559095904597, 42410164806673, 237427062406747, -527158798505034, 154009466580767, 806934800145610, 704537562829621, -471824150440838, -196037865609161, -137336297558938, 22551095540991, 554299305248044, 277695820666722, -21782189958022, -375256516448941, 216163368758078, -102270938114146, -148585677044111, -145172891032706,
    589896156708638, 51889982861632, -207028310663546, -354942219741792, 324226053660146, 632655368250502, 42686548660498, 238974356712474, -530594252740420, 155013134689418, 812193533538096, 709128981129146, -474898992937228, -197315429632778, -138231307879280, 22698059334270, 557911632124284, 279505543440892, -21924142851456, -377702034938714, 217572089171816, -102937430124708, -149553998724346, -146118971843224,
    600756289731806, 52845290181468, -210839752673802, -361476793120676, 330195134882802, 644302708852546, 43472418497894, 243373933271006, -540362623157072, 157866964543910, 827146215827120, 722184219713198, -483641999951620, -200948055119426, -140776180183436, 23115936177398, 568182922199896, 284651309094660, -22327771702192, -384655622101314, 221577644732168, -104832533477228, -152307324545886, -148809057976824,
    607547309886602, 53442659592064, -213223110175526, -365562969544512, 333927699742014, 651585982879622, 43963835858382, 246125060998246, -546470946161724, 159651511383150, 836496374483224, 730347875550638, -489109146322812, -203219595702034, -142367530774816, 23377241454030, 574605729155428, 287869041160376, -22580167474376, -389003814749470, 224082384635764, -106017572834936, -154029024557010, -150491213168888,
    617143543643169, 54286788511200, -216590977622637, -371337051087476, 339202100948917, 661877809215553, 44658246382249, 250012616058163, -555102476340862, 162173213311363, 849708867758126, 741883749092245, -496834644607818, -206429457242917, -144616231546638, 23746485906151, 583681649343220, 292415944035758, -22936822111506, -395148145368313, 227621774751894, -107692124585346, -156461919083727, -152868227824994,
};
#endif

/* Consecutively, real and imaginary parts of first 64 nonreal
   Gaussian primes. */
static const signed char small_gaussian_primes[] = {
    1, 1, 1, 2, 2, 3, 1, 4, 2, 5, 1, 6, 4, 5, 2, 7, 5, 6, 3, 8, 5, 8, 4, 9,
    1, 10, 3, 10, 7, 8, 4, 11, 7, 10, 6, 11, 2, 13, 9, 10, 7, 12, 1, 14, 2, 15, 8, 13, 
    4, 15, 1, 16, 10, 13, 9, 14, 5, 16, 2, 17, 12, 13, 11, 14, 9, 16, 5, 18, 8, 17, 7, 18, 
    10, 17, 6, 19, 1, 20, 3, 20, 14, 15, 12, 17, 7, 20, 4, 21, 10, 19, 5, 22, 11, 20, 10, 21, 
    14, 19, 13, 20, 1, 24, 8, 23, 5, 24, 17, 18, 16, 19, 4, 25, 13, 22, 6, 25, 12, 23, 1, 26, 
    5, 26, 15, 22, 2, 27, 9, 26
};

static const ulong atan_3_x[] = { 18, 57, 239 };
static const ulong atan_3_den = 1;
static const slong atan_3_c[] = {
    12, 8, -5,
    17, 11, -7,
    15, 10, -6,
};

static const ulong atan_4_x[] = { 38, 57, 239, 268 };
static const ulong atan_4_den = 1;
static const slong atan_4_c[] = {
    12, 20, 7, 24,
    17, 28, 10, 34,
    15, 25, 9, 30,
    20, 34, 12, 41,
};

static const ulong atan_8_x[] = { 931, 1772, 2943, 6118, 34208, 44179, 85353, 485298 };
static const ulong atan_8_den = 1;
static const slong atan_8_c[] = {
    398, 525, 163, 68, -295, 71, 215, -183,
    561, 740, 230, 96, -416, 100, 303, -258,
    498, 657, 204, 85, -369, 89, 269, -229,
    672, 886, 275, 115, -498, 120, 363, -309,
    603, 796, 247, 103, -447, 108, 326, -277,
    712, 940, 292, 122, -529, 127, 385, -328,
    454, 599, 186, 78, -337, 81, 245, -209,
    655, 864, 268, 112, -485, 117, 354, -301,
};

static const ulong atan_12_x[] = { 157318, 330182, 390112, 478707, 485298, 617427, 1984933, 2343692, 3449051, 6225244, 22709274, 24208144 };
static const ulong atan_12_den = 1;
static const slong atan_12_c[] = {
    96032, 52094, 29861, 50539, -56156, -13587, -91675, 50539, 19970, -52094, 23407, -25106,
    135373, 73435, 42094, 71243, -79161, -19153, -129231, 71243, 28151, -73435, 32996, -35391,
    120168, 65187, 37366, 63241, -70270, -17002, -114716, 63241, 24989, -65187, 29290, -31416,
    162110, 87939, 50408, 85314, -94796, -22936, -154755, 85314, 33711, -87939, 39513, -42381,
    145539, 78950, 45255, 76593, -85106, -20592, -138936, 76593, 30265, -78950, 35474, -38049,
    171871, 93234, 53443, 90451, -100504, -24317, -164073, 90451, 35741, -93234, 41892, -44933,
    109562, 59434, 34068, 57659, -64067, -15501, -104591, 57659, 22783, -59433, 26705, -28643,
    158036, 85729, 49141, 83170, -92414, -22360, -150866, 83170, 32864, -85729, 38520, -41316,
    107117, 58107, 33308, 56373, -62638, -15155, -102257, 56373, 22275, -58107, 26109, -28004,
    148196, 80392, 46081, 77991, -86658, -20967, -141472, 77990, 30816, -80390, 36122, -38743,
    123763, 67137, 38484, 65133, -72372, -17510, -118148, 65133, 25737, -67137, 30166, -32356,
    140927, 76448, 43821, 74166, -82409, -19939, -134533, 74166, 29306, -76448, 34350, -36843,
};

static const ulong atan_13_x[] = { 683982, 1984933, 2343692, 2809305, 3014557, 6225244, 6367252, 18975991, 22709274, 24208144, 193788912, 201229582, 2189376182 };
static const ulong atan_13_den = 2;
static const slong atan_13_c[] = {
    893758, -387440, 344740, 738156, 36462, -653018, 732158, 560616, 202968, -58948, -1125574, -560064, -432616,
    1259900, -546161, 485968, 1040553, 51399, -920537, 1032098, 790281, 286117, -83097, -1586683, -789503, -609844,
    1118388, -484816, 431384, 923678, 45626, -817142, 916172, 701516, 253980, -73764, -1408466, -700826, -541346,
    1508738, -654031, 581950, 1246069, 61551, -1102349, 1235944, 946367, 342627, -99509, -1900063, -945435, -730292,
    1354512, -587175, 522462, 1118693, 55259, -989665, 1109604, 849627, 307603, -89337, -1705835, -848791, -655640,
    1599582, -693411, 616990, 1321097, 65257, -1168723, 1310362, 1003349, 363257, -105501, -2014469, -1002361, -774264,
    1019682, -442027, 393312, 842157, 41599, -745023, 835314, 639603, 231565, -67253, -1284159, -638973, -493568,
    1470820, -637594, 567324, 1214752, 60004, -1074644, 1204882, 922582, 334016, -97008, -1852310, -921674, -711938,
    996926, -432163, 384534, 823363, 40671, -728397, 816672, 625329, 226397, -65753, -1255501, -624713, -482554,
    1379246, -597896, 532002, 1139122, 56268, -1007736, 1129866, 865142, 313220, -90968, -1736984, -864290, -667612,
    1151848, -499321, 444290, 951313, 46991, -841589, 943582, 722505, 261579, -75971, -1450605, -721793, -557542,
    1311590, -568568, 505906, 1083244, 53508, -958304, 1074442, 822704, 297856, -86506, -1651780, -821894, -634864,
    1674096, -725713, 645732, 1382639, 68297, -1223167, 1371404, 1050089, 380179, -110415, -2108311, -1049055, -810332,
};

static const ulong atan_16_x[] = { 4079486, 6367252, 7691443, 8296072, 9639557, 10292025, 18975991, 19696179, 22709274, 24208144, 168623905, 193788912, 201229582, 284862638, 599832943, 2189376182 };
static const ulong atan_16_den = 1;
static const slong atan_16_c[] = {
    -234928, 371891, 1821154, 2095663, 2092544, -619249, 3406969, -1705235, 801522, 537775, -718269, -1808724, 317867, -446879, 1201905, -1341875,
    -331170, 524242, 2567218, 2954184, 2949787, -872934, 4802687, -2403811, 1129878, 758083, -1012519, -2549696, 448086, -629950, 1694284, -1891595,
    -293973, 465359, 2278868, 2622370, 2618467, -774886, 4263249, -2133815, 1002970, 672935, -898793, -2263314, 397757, -559194, 1503982, -1679131,
    -396578, 627783, 3074260, 3537654, 3532389, -1045344, 5751248, -2878579, 1353036, 907809, -1212498, -3053277, 536586, -754369, 2028916, -2265197,
    -356039, 563610, 2760003, 3176028, 3171301, -938487, 5163344, -2584325, 1214726, 815011, -1088554, -2741165, 481735, -677256, 1821516, -2033644,
    -420457, 665583, 3259367, 3750663, 3745081, -1108286, 6097542, -3051904, 1434505, 962470, -1285505, -3237121, 568895, -799791, 2151081, -2401589,
    -268028, 424288, 2077742, 2390928, 2387369, -706497, 3886988, -1945491, 914451, 613544, -819468, -2063561, 362652, -509841, 1371245, -1530936,
    -386611, 612006, 2996996, 3448744, 3443611, -1019072, 5606705, -2806233, 1319031, 884994, -1182025, -2976541, 523100, -735410, 1977924, -2208267,
    -262046, 414819, 2031373, 2337569, 2334090, -690730, 3800241, -1902073, 894043, 599851, -801180, -2017508, 354559, -498463, 1340643, -1496770,
    -362541, 573902, 2810403, 3234025, 3229212, -955624, 5257631, -2631517, 1236908, 829894, -1108432, -2791221, 490532, -689623, 1854779, -2070780,
    -302768, 479282, 2347047, 2700826, 2696806, -798069, 4390797, -2197654, 1032977, 693068, -925683, -2331028, 409657, -575924, 1548978, -1729367,
    -344757, 545750, 2672544, 3075386, 3070809, -908748, 4999728, -2502433, 1176234, 789185, -1054060, -2654303, 466470, -655795, 1763796, -1969202,
    -440043, 696588, 3411200, 3925382, 3919540, -1159914, 6381586, -3194072, 1501329, 1007305, -1345388, -3387917, 595396, -837048, 2251286, -2513463,
    -382676, 605775, 2966488, 3413638, 3408557, -1008698, 5549632, -2777667, 1305604, 875985, -1169992, -2946241, 517775, -727924, 1957790, -2185788,
    -254840, 403411, 1975510, 2273286, 2269903, -671735, 3695735, -1849767, 869457, 583355, -779148, -1962027, 344809, -484755, 1303776, -1455609,
    -365532, 578637, 2833590, 3260707, 3255854, -963509, 5301009, -2653228, 1247113, 836741, -1117577, -2814250, 494579, -695313, 1870081, -2087865,
};

#if HAVE_64_BIT
static const ulong atan_22_x[] = {1479406293, 1892369318, 2112819717, 2189376182, 2701984943, 2971354082, 3558066693, 4038832337, 5271470807, 6829998457, 7959681215, 8193535810, 12139595709, 12185104420, 12957904393, 14033378718, 18710140581, 18986886768, 20746901917, 104279454193, 120563046313, 69971515635443};
static const slong atan_22_c[] = {
    -686576870, 1656337239, -259447943, -1575862355, -586963256, 2831731070, -713071113, 1093399495, 462322718, -1204188516, 1196364387, 1658902, -46276061, 42040652, 2649880866, 1607783027, 325822937, -351517254, 909623840, -657099816, -765606746, 241797349,
    -967843747, 2334881511, -365734822, -2221438841, -827421869, 3991793678, -1005191768, 1541327578, 651720399, -1697503042, 1686473637, 2338497, -65233768, 59263258, 3735445714, 2266436312, 459301363, -495521756, 1282265372, -926290960, -1079249439, 340853388,
    -859135493, 2072627513, -324655470, -1971926729, -734485807, 3543435230, -892288583, 1368205594, 578519134, -1506839423, 1497048841, 2075837, -57906708, 52606806, 3315880281, 2011870082, 407712613, -439864730, 1138241267, -822249917, -958028093, 302568720,
    -1158999071, 2796035528, -437969786, -2660187206, -990842975, 4780198435, -1203723565, 1845749623, 780439342, -2032770739, 2019562956, 2800365, -78117854, 70968130, 4473220110, 2714071965, 550016317, -593390469, 1535520976, -1109239343, -1292408099, 408174110,
    -1040523885, 2510219225, -393199645, -2388257588, -889557039, 4291557060, -1080676552, 1657073432, 700661283, -1824976878, 1813119221, 2514106, -70132492, 63713627, 4015958669, 2436634140, 493792557, -532732917, 1378556973, -995850695, -1160295577, 366449742,
    -1228784594, 2964390108, -464340774, -2820362102, -1050503502, 5068023211, -1276202034, 1956885694, 827431069, -2155167704, 2141164656, 2968980, -82821478, 75241255, 4742561141, 2877491364, 583133838, -629119629, 1627977594, -1176028739, -1370226431, 432751044,
    -783310848, 1889703810, -296002381, -1797890566, -669662358, 3230702580, -813537948, 1247451994, 527460822, -1373850429, 1364923934, 1892630, -52796041, 47963892, 3023230928, 1834308642, 371729157, -401043627, 1037783608, -749680679, -873475492, 275864939,
    -1129870629, 2725764411, -426962549, -2593330285, -965940701, 4660060518, -1173471088, 1799361483, 760825019, -1981682307, 1968806468, 2729985, -76154564, 69184530, 4360797299, 2645860790, 536193080, -578477135, 1496929630, -1081361483, -1259926766, 397915710,
    -765829642, 1847531151, -289396474, -1757766910, -654717454, 3158602753, -795382162, 1219612516, 515689440, -1343190108, 1334462826, 1850392, -51617788, 46893478, 2955761261, 1793372241, 363433250, -392093507, 1014623315, -732950000, -853982075, 269708441,
    -1059524736, 2556057963, -400379805, -2431869203, -905801107, 4369924542, -1100410625, 1687333002, 713455954, -1858302508, 1846228320, 2560016, -71413171, 64877092, 4089293490, 2481129152, 502809629, -542461073, 1403730596, -1014035776, -1181483561, 373141426,
    -884839166, 2134636521, -334368534, -2030922964, -756460202, 3649447961, -918984132, 1409139660, 595827308, -1551921145, 1541837648, 2137942, -59639165, 54180700, 3415085008, 2072061345, 419910586, -453024632, 1172295245, -846850045, -986690441, 311620991,
    -1007551725, 2430675304, -380739920, -2312578392, -861368722, 4155566039, -1046432033, 1604564027, 678458702, -1767146942, 1755665031, 2434439, -67910131, 61694667, 3888700820, 2359421986, 478145240, -515851656, 1334873208, -964294141, -1123528087, 354837669,
    -1286025714, 3102481854, -485971405, -2951744515, -1099439660, 5304109606, -1335652026, 2048044331, 865975726, -2255563017, 2240907657, 3107286, -86679594, 78746258, 4963486365, 3011535060, 610298269, -658426241, 1703814532, -1230812305, -1434056411, 452910114,
    -1118368966, 2698017143, -422616229, -2566931147, -956107784, 4612622835, -1161525589, 1781044652, 753080103, -1961509518, 1948764750, 2702195, -75379339, 68480257, 4316406004, 2618926911, 530734834, -572588453, 1481691443, -1070353625, -1247101180, 393865076,
    -744769216, 1796723777, -281438029, -1709428066, -636712629, 3071740720, -773509038, 1186072995, 501507906, -1306252186, 1297764905, 1799506, -50198291, 45603901, 2874477399, 1744054245, 353438783, -381310879, 986721027, -712793769, -830497445, 262291420,
    -1068266212, 2577146400, -403683088, -2451933036, -913274306, 4405978059, -1109489426, 1701254132, 719342233, -1873634201, 1861460396, 2581137, -72002356, 65412352, 4123031695, 2501599398, 506957997, -546936581, 1415311900, -1022401951, -1191231244, 376219983,
    -839271258, 2024705898, -317149049, -1926333436, -717503621, 3461506790, -871657809, 1336571052, 565143083, -1471999502, 1462435290, 2027841, -56567836, 51390474, 3239213182, 1965353251, 398285812, -429694534, 1111923774, -803238520, -935877343, 295572971,
    -936636410, 2259595150, -353941999, -2149810347, -800742322, 3863081528, -972780175, 1491628720, 630706203, -1642768433, 1632094662, 2263094, -63130358, 57352362, 3614999296, 2193356911, 444491563, -479544059, 1240919765, -896423459, -1044449916, 329862847,
    -1239711235, 2990750161, -468469801, -2845441424, -1059844826, 5113089264, -1287550323, 1974286781, 834788780, -2174331962, 2160204395, 2995381, -83557945, 75910318, 4784733109, 2903078693, 588319201, -634713910, 1642453953, -1186486262, -1382410807, 436599168,
    -732543763, 1767230397, -276818199, -1681367652, -626260935, 3021317824, -760811818, 1166603502, 493275609, -1284809940, 1276461979, 1769967, -49374282, 44855308, 2827292597, 1715425440, 347637054, -375051627, 970523914, -701093196, -816864755, 257985883,
    -911523298, 2199010843, -344452100, -2092169592, -779272804, 3759504514, -946697974, 1451635144, 613795697, -1598722495, 1588334910, 2202416, -61437706, 55814630, 3518073868, 2134548585, 432573847, -466686514, 1207648201, -872388537, -1016446105, 321018558,
    -1310818407, 3162293162, -495340222, -3008649828, -1120635247, 5406365074, -1361401442, 2087527627, 882670470, -2299046970, 2284109076, 3167190, -88350649, 80264371, 5059175116, 3069593047, 622063926, -671119736, 1736661582, -1254540564, -1461702920, 461641558,
};
#endif

typedef struct
{
    const ulong * x;
    arb_ptr res;
    slong prec;
    int hyperbolic;
}
atan_work;

static void
parallel_atan_worker(slong i, atan_work * work)
{
    fmpz_t p, q;

    fmpz_init(p);
    fmpz_init(q);

    fmpz_one(p);
    if (work->x[i] == L24_FIXME)
        fmpz_set_str(q, L24_FIXME_STR, 10);
    else
        fmpz_set_ui(q, work->x[i]);

    arb_atan_frac_bsplit(work->res + i, p, q, work->hyperbolic, work->prec);

    fmpz_clear(p);
    fmpz_clear(q);
}

void
arb_log_primes_vec_bsplit(arb_ptr res, slong n, slong prec)
{
    ulong den, prime;
    const ulong * x;
    ulong * primes;
    const slong * c;
    slong i, j, k, wp, ln;
    arb_ptr y;
    arb_t t;
    fmpz_t p, q;
    n_primes_t iter;

    wp = prec + 64;

    switch (n)
    {
#if HAVE_64_BIT
        case 1:
        case 2:
        case 3:
        case 4:
        case 5: ln = 4; x = log_atanh_4_x; den = log_atanh_4_den; c = log_atanh_4_c; break;
        case 6:
        case 7:
        case 8:
        case 9: ln = 8; x = log_atanh_8_x; den = log_atanh_8_den; c = log_atanh_8_c; break;
        case 10:
        case 11:
        case 12: ln = 12; x = log_atanh_12_x; den = log_atanh_12_den; c = log_atanh_12_c; break;
        case 13:
        case 14: ln = 13; x = log_atanh_13_x; den = log_atanh_13_den; c = log_atanh_13_c; break;
        case 15:
        case 16:
        case 17: ln = 16; x = log_atanh_16_x; den = log_atanh_16_den; c = log_atanh_16_c; break;
        case 18:
        case 19:
        case 20:
        case 21: ln = 20; x = log_atanh_20_x; den = log_atanh_20_den; c = log_atanh_20_c; break;
        case 22:
        case 23:
        case 24:
        default: ln = 24; x = log_atanh_24_x; den = log_atanh_24_den; c = log_atanh_24_c; break;
#else
        case 1:
        case 2:
        case 3:
        case 4:
        case 5: ln = 4; x = log_atanh_4_x; den = log_atanh_4_den; c = log_atanh_4_c; break;
        case 6:
        case 7:
        case 8:
        case 9: ln = 8; x = log_atanh_8_x; den = log_atanh_8_den; c = log_atanh_8_c; break;
        case 10:
        case 11:
        case 13:
        default: ln = 13; x = log_atanh_13_x; den = log_atanh_13_den; c = log_atanh_13_c; break;
#endif
    }

    y = _arb_vec_init(ln);
    arb_init(t);
    fmpz_init(p);
    fmpz_init(q);

    primes = flint_malloc(sizeof(ulong) * n);
    n_primes_init(iter);
    for (i = 0; i < n; i++)
        primes[i] = n_primes_next(iter);
    n_primes_clear(iter);

    {
        atan_work work;

        work.x = x;
        work.res = y;
        work.prec = wp;
        work.hyperbolic = 1;
        flint_parallel_do((do_func_t) parallel_atan_worker, &work, ln, -1, FLINT_PARALLEL_STRIDED);
    }

    for (i = 0; i < FLINT_MIN(n, ln); i++)
    {
        arb_dot_si(res + i, NULL, 0, y, 1, c + i * ln, 1, ln, wp);
        if (den == 1)
            arb_set_round(res + i, res + i, prec);
        else
            arb_div_ui(res + i, res + i, den, prec);
    }

    /* todo: sieving instead of factoring */
    /* todo: parallel comp here as well */
    for (i = ln; i < n; i++)
    {
        n_factor_t fac;

        prime = primes[i];

        fmpz_one(p);
        fmpz_set_ui(q, 2 * prime * prime - 1);

        arb_atan_frac_bsplit(res + i, p, q, 1, wp);
        arb_mul_2exp_si(res + i, res + i, 1);

        n_factor_init(&fac);
        n_factor(&fac, (prime - 1) / 2, 1);

        for (j = 0; j < fac.num; j++)
            for (k = 0; k < i; k++)
                if (fac.p[j] == primes[k])
                    arb_addmul_ui(res + i, res + k, fac.exp[j], wp);

        n_factor_init(&fac);
        n_factor(&fac, (primes[i] + 1) / 2, 1);

        for (j = 0; j < fac.num; j++)
            for (k = 0; k < i; k++)
                if (fac.p[j] == primes[k])
                    arb_addmul_ui(res + i, res + k, fac.exp[j], wp);

        arb_mul_2exp_si(res + i, res + i, -1);

        arb_add(res + i, res + i, res + 0, prec);
    }

    _arb_vec_clear(y, ln);
    arb_clear(t);
    fmpz_clear(p);
    fmpz_clear(q);
    flint_free(primes);
}

FLINT_TLS_PREFIX arb_struct _arb_log_p_cache[ARB_LOG_PRIME_CACHE_NUM];
FLINT_TLS_PREFIX slong _arb_log_p_cache_prec = 0;

void _arb_log_p_cleanup(void)
{
    slong i;
    for (i = 0; i < ARB_LOG_PRIME_CACHE_NUM; i++)
        arb_clear(_arb_log_p_cache + i);
    _arb_log_p_cache_prec = 0;
}

void _arb_log_p_ensure_cached(slong prec)
{
    slong i, wp;

    if (_arb_log_p_cache_prec < prec)
    {
        if (_arb_log_p_cache_prec == 0)
        {
            for (i = 0; i < ARB_LOG_PRIME_CACHE_NUM; i++)
                arb_init(_arb_log_p_cache + i);

            flint_register_cleanup_function(_arb_log_p_cleanup);
        }

        wp = prec + 32;

        if (wp <= ARB_LOG_TAB2_PREC - 16)
        {
            for (i = 0; i < ARB_LOG_PRIME_CACHE_NUM; i++)
            {
                slong exp, exp_fix;
                mp_size_t n;
                arb_ptr res = _arb_log_p_cache + i;

                n = ARB_LOG_TAB2_PREC / FLINT_BITS;

                /* exponent of log(prime(i+1)) */
                exp = (i >= 1) + (i >= 4) + (i >= 16) + (i >= 429);

                /* just reading the table is known to give the correct rounding */
                _arf_set_round_mpn(arb_midref(res), &exp_fix, arb_log_p_tab[i], n, 0, wp, ARF_RND_NEAR);
                exp += exp_fix;
                _fmpz_set_si_small(ARF_EXPREF(arb_midref(res)), exp);

                /* 1/2 ulp error */
                _fmpz_set_si_small(MAG_EXPREF(arb_radref(res)), exp - wp);
                MAG_MAN(arb_radref(res)) = MAG_ONE_HALF;
            }
        }
        else
        {
            prec = FLINT_MAX(prec, _arb_log_p_cache_prec * 1.25);

            arb_log_primes_vec_bsplit(_arb_log_p_cache, ARB_LOG_PRIME_CACHE_NUM, prec + 32);
        }

        _arb_log_p_cache_prec = prec;
    }
}

static int factor_smooth(ulong * c, ulong n)
{
    slong i;

    for (i = 0; i < ARB_LOG_PRIME_CACHE_NUM; i++)
        c[i] = 0;

    /* Hardcoded so that the compiler can remove divisions */
    while (n != 1 && n % 2 == 0) { n /= 2; c[0]++; }
    while (n != 1 && n % 3 == 0) { n /= 3; c[1]++; }
    while (n != 1 && n % 5 == 0) { n /= 5; c[2]++; }
    while (n != 1 && n % 7 == 0) { n /= 7; c[3]++; }
    while (n != 1 && n % 11 == 0) { n /= 11; c[4]++; }
    while (n != 1 && n % 13 == 0) { n /= 13; c[5]++; }
    while (n != 1 && n % 17 == 0) { n /= 17; c[6]++; }
    while (n != 1 && n % 19 == 0) { n /= 19; c[7]++; }
    while (n != 1 && n % 23 == 0) { n /= 23; c[8]++; }
    while (n != 1 && n % 29 == 0) { n /= 29; c[9]++; }
    while (n != 1 && n % 31 == 0) { n /= 31; c[10]++; }
    while (n != 1 && n % 37 == 0) { n /= 37; c[11]++; }
    while (n != 1 && n % 41 == 0) { n /= 41; c[12]++; }

    return n == 1;
}

/* todo: use in log_ui in appropriates ranges */
int
_arb_log_ui_smooth(arb_t res, ulong n, slong prec)
{
    ulong c[ARB_LOG_PRIME_CACHE_NUM];

    if (factor_smooth(c, n))
    {
        _arb_log_p_ensure_cached(prec);
        arb_dot_ui(res, NULL, 0, _arb_log_p_cache, 1, c, 1, ARB_LOG_PRIME_CACHE_NUM, prec);
        return 1;
    }
    else
    {
        return 0;
    }
}

void
arb_atan_gauss_primes_vec_bsplit(arb_ptr res, slong n, slong prec)
{
    const ulong * x;
    const slong * c;
    slong i, j, wp, ln;
    arb_ptr y;
    arb_t t;
    fmpz_t p, q;
    ulong den;

    /* not implemented */
    if (n > 64)
        flint_abort();

    wp = prec + 64;

    switch (n)
    {
        case 1:
        case 2:
        case 3: ln = 3; x = atan_3_x; den = atan_3_den; c = atan_3_c; break;
        case 4: ln = 4; x = atan_4_x; den = atan_4_den; c = atan_4_c; break;
        case 5:
        case 6:
        case 7:
        case 8: ln = 8; x = atan_8_x; den = atan_8_den; c = atan_8_c; break;
        case 9:
        case 10:
        case 11:
        case 12: ln = 12; x = atan_12_x; den = atan_12_den; c = atan_12_c; break;
        case 13: ln = 13; x = atan_13_x; den = atan_13_den; c = atan_13_c; break;
        case 14:
        case 15:
        case 16: ln = 16; x = atan_16_x; den = atan_16_den; c = atan_16_c; break;
#if HAVE_64_BIT
        case 17:
        case 18:
        case 19:
        case 20:
        case 21:
        case 22:
        default: ln = 22; x = atan_22_x; den = atan_12_den; c = atan_22_c; break;
#else
        default: ln = 16; x = atan_16_x; den = atan_16_den; c = atan_16_c; break;
#endif
    }

    y = _arb_vec_init(ln);
    arb_init(t);
    fmpz_init(p);
    fmpz_init(q);

    {
        atan_work work;

        work.x = x;
        work.res = y;
        work.prec = wp;
        work.hyperbolic = 0;
        flint_parallel_do((do_func_t) parallel_atan_worker, &work, ln, -1, FLINT_PARALLEL_STRIDED);
    }

    for (i = 0; i < FLINT_MIN(n, ln); i++)
    {
        arb_dot_si(res + i, NULL, 0, y, 1, c + i * ln, 1, ln, wp);
        if (den == 1)
            arb_set_round(res + i, res + i, prec);
        else
            arb_div_ui(res + i, res + i, den, prec);
    }

    for (i = ln; i < n; i++)
    {
        double best = 100, t;
        slong xa, xb, ya, yb;
        slong best_j = 0;

        xa = small_gaussian_primes[2 * i];
        xb = small_gaussian_primes[2 * i + 1];

        for (j = 0; j < FLINT_MIN(i, 100); j++)
        {
            ya = small_gaussian_primes[2 * j];
            yb = small_gaussian_primes[2 * j + 1];

            t = (xb*ya - xa*yb) / (double) (xa*ya + xb*yb);

            if (fabs(t) < best)
            {
                best = fabs(t);
                best_j = j;
            }
        }

        ya = small_gaussian_primes[2 * best_j];
        yb = small_gaussian_primes[2 * best_j + 1];

        fmpz_set_si(p, xb*ya - xa*yb);
        fmpz_set_si(q, xa*ya + xb*yb);

        arb_atan_frac_bsplit(res + i, p, q, 0, wp);
        arb_add(res + i, res + i, res + best_j, prec);
    }

    _arb_vec_clear(y, ln);
    arb_clear(t);
    fmpz_clear(p);
    fmpz_clear(q);
}

FLINT_TLS_PREFIX arb_struct _arb_atan_gauss_p_cache[ARB_ATAN_GAUSS_PRIME_CACHE_NUM];
FLINT_TLS_PREFIX slong _arb_atan_gauss_p_cache_prec = 0;

void _arb_atan_gauss_p_cleanup(void)
{
    slong i;
    for (i = 0; i < ARB_ATAN_GAUSS_PRIME_CACHE_NUM; i++)
        arb_clear(_arb_atan_gauss_p_cache + i);
    _arb_atan_gauss_p_cache_prec = 0;
}

void _arb_atan_gauss_p_ensure_cached(slong prec)
{
    slong i, wp;

    if (_arb_atan_gauss_p_cache_prec < prec)
    {
        if (_arb_atan_gauss_p_cache_prec == 0)
        {
            for (i = 0; i < ARB_ATAN_GAUSS_PRIME_CACHE_NUM; i++)
                arb_init(_arb_atan_gauss_p_cache + i);

            flint_register_cleanup_function(_arb_atan_gauss_p_cleanup);
        }

        wp = prec + 32;

        /* todo */
        if (0 && wp <= ARB_ATAN_TAB2_PREC - 16)
        {
        }
        else
        {
            prec = FLINT_MAX(prec, _arb_atan_gauss_p_cache_prec * 1.25);

            arb_atan_gauss_primes_vec_bsplit(_arb_atan_gauss_p_cache, ARB_ATAN_GAUSS_PRIME_CACHE_NUM, prec + 32);
            _arb_vec_scalar_mul_2exp_si(_arb_atan_gauss_p_cache, _arb_atan_gauss_p_cache, ARB_ATAN_GAUSS_PRIME_CACHE_NUM, 1);
        }

        _arb_atan_gauss_p_cache_prec = prec;
    }
}
